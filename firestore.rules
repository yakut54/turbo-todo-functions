rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†ĞµĞ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
    function isOwner(docPath) {
      return request.auth != null &&
             get(docPath).data.ownerId == request.auth.uid;
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ ownerId ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ UID
    function isValidOwner() {
      return request.resource.data.ownerId == request.auth.uid;
    }

    // ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡
    function hasValidTaskFields() {
      return request.resource.data.keys().hasAll(['title', 'listId', 'ownerId']);
    }

    // ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ²
    function hasValidListFields() {
      return request.resource.data.keys().hasAll(['title', 'ownerId']);
    }


    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞšĞĞ›Ğ›Ğ•ĞšĞ¦Ğ˜Ğ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¾Ğ¹
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞºĞ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†
    match /lists/{listId} {
      allow read, write: if isOwner(/databases/$(database)/documents/lists/$(listId));
      allow create: if request.auth != null &&
                    isValidOwner() &&
                    hasValidListFields();
    }

    // âœ… Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†
    match /tasks/{taskId} {
      allow read, write: if isOwner(/databases/$(database)/documents/tasks/$(taskId));
      allow create: if request.auth != null &&
                    isValidOwner() &&
                    hasValidTaskFields();
    }

    // ğŸ”” ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†
    match /reminders/{reminderId} {
      allow read, write: if isOwner(/databases/$(database)/documents/reminders/$(reminderId));
      allow create: if request.auth != null &&
                    isValidOwner();
    }

    // â³ Ğ¡Ğ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    match /stats/{statId} {
      allow read: if isOwner(/databases/$(database)/documents/stats/$(statId));
      allow write: if request.auth != null; // Cloud Function Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ
    }
  }
}
